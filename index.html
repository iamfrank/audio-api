<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <title>Sounds</title>
        <meta name="description" content="Forays into using web audio API for fun and profit.">

        <style>

            body {
                font: 1em/1.2 sans-serif;
                background-color: #ccc;
                padding: 0;
                margin: 0;
            }

            #keyboard {
                display: flex;
                flex-flow: row nowrap;
            }

            .key {
                border: solid 1px #ccc;
                background-color: #fff;
                flex: 1 0 7.6%;
                min-height: 8rem;
            }

            .key:active {
                background-color: #000;
                color: #fff;
            }

            .key:focus {
                outline: none;
            }

        </style>

    </head>
    <body>

        <h1 style="padding: 1rem; font-size: 1.5rem; color: #fff; background: #000; margin: 0;">Sounds with Audio API</h1>
        <fieldset>
            <label for="power-on">Turn on</label>
            <input type="checkbox" id="power-on">
            <label for="vol">Volume</label>
            <input id="vol" type="range" min="0" max="1" step="0.1" value="0.5">
        </fieldset>
        <div id="keyboard"></div>
        
        <script>

            const audioContext = new AudioContext(),
                keys = [
                    {tone: 'C', octave: 2, freq: 65.41},
                    {tone: 'C#', octave: 2, freq: 69.30}, 
                    {tone: 'D', octave: 2, freq: 73.42},
                    {tone: 'Eb', octave: 2, freq: 77.78}, 
                    {tone: 'E', octave: 2, freq: 82.41},
                    {tone: 'F', octave: 2, freq: 87.31}, 
                    {tone: 'F#', octave: 2, freq: 92.50},
                    {tone: 'G', octave: 2, freq: 98.00}, 
                    {tone: 'Ab', octave: 2, freq: 103.83},
                    {tone: 'A', octave: 2, freq: 110.00},
                    {tone: 'A#', octave: 2, freq: 116.54},
                    {tone: 'B', octave: 2, freq: 123.47},
                    {tone: 'C', octave: 3, freq: 130.81}
                ],
                vol_btn = document.getElementById('vol'),
                gainNode = audioContext.createGain()
            
            let oscillator = audioContext.createOscillator()

            function keyDown(freq) {
                oscillator.frequency.setValueAtTime(freq, audioContext.currentTime)
                oscillator.connect(gainNode)
            }

            function keyUp() {
                oscillator.disconnect(gainNode)
            }
            
            function attachSound(button, freq) {
                button.addEventListener('pointerdown', function(ev) {
                    ev.preventDefault()
                    keyDown(freq)
                }, false)
                button.addEventListener('pointerup', function(ev) {
                    ev.preventDefault()
                    keyUp()
                }, false)
            }

            function attachVolumeControl(btn, audioctx) {
                gainNode.connect(audioctx.destination)
                btn.addEventListener('change', function(ev) {
                    gainNode.gain.setValueAtTime(ev.target.value, audioctx.currentTime)
                })
            }

            function renderKeyboard() {
                let kb = document.getElementById('keyboard')
                for (let k of keys) {
                    let btn = document.createElement('button')
                    btn.className = 'key'
                    //btn.innerHTML = k.tone
                    kb.appendChild(btn)
                    attachSound(btn, k.freq, gainNode)
                }
            }
            
            (function init() {

                oscillator.type = 'triangle'

                attachVolumeControl(vol_btn, audioContext)

                document.getElementById('power-on').addEventListener('click', function() {
                    oscillator.start()
                })

                renderKeyboard()
            })()

        </script>
    </body>
</html>