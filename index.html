<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <title>Sounds</title>
        <meta name="description" content="Forays into using web audio API for fun and profit.">

        <style>

            body {
                font: 1em/1.2 sans-serif;
                background-color: #ccc;
                padding: 0;
                margin: 0;
            }

            fieldset {
                border: none;
                padding: .5rem;
            }

            .power-panel {
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
            }

            #keyboard {
                display: flex;
                flex-flow: row nowrap;
            }

            .key-wrap {
                position: relative;
                min-height: 8rem;
                background-color: #fff;
                padding: 1rem;
            }

            .key {
                border: solid 1px #ccc;
                background-color: transparent;
                flex: 1 0 7.6%;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }

            .key:active {
                background-color: #000;
                color: #fff;
            }

            .key:focus {
                outline: none;
            }

            .freq {
                font-size: .6em;
            }

        </style>

    </head>
    <body>

        <h1 style="padding: 1rem; font-size: 1.5rem; color: #fff; background: #000; margin: 0;">Sounds</h1>
        
        <div class="power-panel">
            <fieldset>
                <input type="checkbox" id="power-on">
                <label for="power-on">Power on</label>
            </fieldset>
            <fieldset>
                <label for="vol">Volume</label>
                <input id="vol" type="range" min="0" max="1" step="0.1" value="0.5">
            </fieldset>
        </div>
        
        <div id="keyboard"></div>
        

        <script>

            const power_btn = document.getElementById('power-on'),
                vol_btn = document.getElementById('vol'),
                tones = [
                    {n: -33, t: 'C', o: 2},{n: -32, t: 'C#', o: 2}, {n: -31, t: 'D', o: 2}, {n: -30, t: 'Eb', o: 2}, {n: -29, t: 'E', o: 2}, {n: -28, t: 'F', o: 2}, {n: -27, t: 'F#', o: 2}, {n: -26, t: 'G', o: 2}, {n: -25, t: 'Ab', o: 2}, {n: -24, t: 'A', o: 2}, {n: -23, t: 'A#', o: 2}, {n: -22, t: 'B', o: 2},
                    {n: -21, t: 'C', o: 3},{n: -20, t: 'C#', o: 3}, {n: -19, t: 'D', o: 3}, {n: -18, t: 'Eb', o: 3}, {n: -17, t: 'E', o: 3}, {n: -16, t: 'F', o: 3}, {n: -15, t: 'F#', o: 3}, {n: -14, t: 'G', o: 3}, {n: -13, t: 'Ab', o: 3}, {n: -12, t: 'A', o: 3}, {n: -11, t: 'A#', o: 3}, {n: -10, t: 'B', o: 3},
                    {n: -9, t: 'C', o: 4},{n: -8, t: 'C#', o: 4}, {n: -7, t: 'D', o: 4}, {n: -6, t: 'Eb', o: 4}, {n: -5, t: 'E', o: 4}, {n: -4, t: 'F', o: 4}, {n: -3, t: 'F#', o: 4}, {n: -2, t: 'G', o: 4}, {n: -1, t: 'Ab', o: 4}, {n: 0, t: 'A', o: 4}, {n: 1, t: 'A#', o: 4}, {n: 2, t: 'B', o: 4},
                    {n: 3, t: 'C', o: 5},{n: 4, t: 'C#', o: 5}, {n: 5, t: 'D', o: 5}, {n: 6, t: 'Eb', o: 5}, {n: 7, t: 'E', o: 5}, {n: 8, t: 'F', o: 5}, {n: 9, t: 'F#', o: 5}, {n: 10, t: 'G', o: 5}, {n: 11, t: 'Ab', o: 5}, {n: 12, t: 'A', o: 5}, {n: 13, t: 'A#', o: 5}, {n: 14, t: 'B', o: 5},
                    {n: 15, t: 'C', o: 6},{n: 16, t: 'C#', o: 6}, {n: 17, t: 'D', o: 6}, {n: 18, t: 'Eb', o: 6}, {n: 19, t: 'E', o: 6}, {n: 20, t: 'F', o: 6}, {n: 21, t: 'F#', o: 6}, {n: 22, t: 'G', o: 6}, {n: 23, t: 'Ab', o: 6 }, {n: 24, t: 'A', o: 6}, {n: 25, t: 'A#', o: 6}, {n: 26, t: 'B', o: 6}
                ]

            let kb = document.getElementById('keyboard'),
                audioContext = new AudioContext(),
                oscillator,
                volumeNode,
                gainNode

            function calcFreq(half_step) {
                return 440 * Math.pow( Math.pow(2,(1/12)), half_step )
            }

            function keyDown(ev) {
                ev.preventDefault()
                oscillator.frequency.setTargetAtTime(ev.target.dataset.freq, audioContext.currentTime, 0)
                gainNode.gain.setTargetAtTime(1, audioContext.currentTime, 0.05)
            }

            function keyUp(ev) {
                ev.preventDefault()
                gainNode.gain.setTargetAtTime(0.01, audioContext.currentTime, 0.2)
            }
            
            function buildKey(key) {
                let btn_wrap = document.createElement('div'),
                    btn = document.createElement('button')
                btn_wrap.className = 'key-wrap'
                btn.className = 'key'
                btn_wrap.innerHTML = `${ key.tone }<sub>${ key.octave }</sub> <span class="freq">${ key.freq.toFixed(1) }Hz</span>`
                btn.dataset.freq = key.freq
                btn_wrap.appendChild(btn)
                btn.addEventListener('pointerdown', keyDown, false)
                btn.addEventListener('pointerup', keyUp, false)
                return btn_wrap
            }

            function renderKeyboard() {
                let keys = [],
                    lowest = 18,
                    highest = 46
                for (let i = lowest; i < highest; i++) {
                    let key = {
                        tone: tones[i].t,
                        octave: tones[i].o,
                        freq: calcFreq(tones[i].n)
                    }
                    keys.push(key)
                }
                for (let k in keys) {
                    kb.appendChild( buildKey(keys[k]) )
                }
            }
            
            function init() {
                renderKeyboard()
                power_btn.addEventListener('click', function() {
                    volumeNode = audioContext.createGain()
                    volumeNode.gain.setTargetAtTime(0.5, audioContext.currentTime, 0);
                    volumeNode.connect(audioContext.destination)
                    gainNode = audioContext.createGain()
                    gainNode.gain.setTargetAtTime(0.01, audioContext.currentTime, 0);
                    gainNode.connect(volumeNode)
                    oscillator = audioContext.createOscillator()
                    oscillator.type = 'sine'
                    oscillator.connect(gainNode)
                    oscillator.start()
                    vol_btn.addEventListener('change', function(ev) {
                        volumeNode.gain.setTargetAtTime(parseFloat(ev.target.value), audioContext.currentTime, 0);
                    })
                })
                //octave_select.addEventListener('change', function() { renderKeyboard() })
                //key_select.addEventListener('change', function() { renderKeyboard() })
                
            }

            init()

        </script>
    </body>
</html>